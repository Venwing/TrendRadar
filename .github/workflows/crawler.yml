name: Hot News Crawler

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  crawl:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Run TrendRadar crawler
      run: |
        python main.py

    # ⭐ 将最新生成的 HTML 复制为 index.html（GitHub Pages 可访问）
    - name: Copy latest HTML to root as index.html
      run: |
        latest_html=$(ls -t output/*/html/*.html | head -n 1)
        cp "$latest_html" index.html
        echo "Published HTML: $latest_html"

    # ⭐ 上传 index.html（方便调试，可选）
    - name: Upload published index.html
      uses: actions/upload-artifact@v4
      with:
        name: published-index
        path: index.html

    # ⭐ 自动推送更新到仓库（让 GitHub Pages 更新）
    - name: Commit and push index.html
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Actions"
        git add index.html
        git commit -m "Update index.html" || echo "No changes to commit"
        git push

    # ⭐ 微信推送链接（不会再推文本）
    - name: Send WeChat Notification (only URL)
      run: |
        PAGE_URL="https://venwing.github.io/TrendRadar/index.html"
        curl -X POST "https://sctapi.ftqq.com/${{ secrets.SERVERCHAN_KEY }}.send" \
          -d "title=今日趋势热讯（网页版）" \
          -d "desp=点击查看今日汇总：$PAGE_URL"
